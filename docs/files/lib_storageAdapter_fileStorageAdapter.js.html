<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/storageAdapter/fileStorageAdapter.js - kobold-core</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="kobold-core"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.9.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Company.html">Company</a></li>
            
                <li><a href="../classes/ConnectionAdapter.html">ConnectionAdapter</a></li>
            
                <li><a href="../classes/Department.html">Department</a></li>
            
                <li><a href="../classes/FileStorageAdapter.html">FileStorageAdapter</a></li>
            
                <li><a href="../classes/KeyValueStorageAdapter.html">KeyValueStorageAdapter</a></li>
            
                <li><a href="../classes/RiakConnectionAdapter.html">RiakConnectionAdapter</a></li>
            
                <li><a href="../classes/StorageAdapter.html">StorageAdapter</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib/storageAdapter/fileStorageAdapter.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
// Copyright 2014, Yahoo! Inc.
// Copyrights licensed under the Mit License. See the accompanying LICENSE file for terms.

var path = require(&#x27;path&#x27;);
var fs = require(&#x27;fs&#x27;);

var Promise = require(&#x27;promise&#x27;);
var PNGImage = require(&#x27;pngjs-image&#x27;);

var StorageAdapter = require(&#x27;./storageAdapter&#x27;);


/**
 * File storage adapter
 *
 * @class FileStorageAdapter
 * @extends StorageAdapter
 * @constructor
 * @param {Object} options
 * @param {String} options.path
 * @param {String} options.approvedFolderName
 * @param {String} options.buildFolderName
 * @param {String} options.highlightFolderName
 *
 * @property {string} _path
 * @property {string} _approvedFolderName
 * @property {string} _buildFolderName
 * @property {string} _highlightFolderName
 */
var FileStorageAdapter = StorageAdapter.extend(

	/** @lends FileStorageAdapter.prototype */
	{
		/**
		 * Initializes the source-adapter
		 *
		 * @method initialize
		 */
		initialize: function () {
			this.__super();

			this._path = this._options.path;

			this._approvedFolderName = this._options.approvedFolderName || &#x27;approved&#x27;;
			this._buildFolderName = this._options.buildFolderName || &#x27;build&#x27;;
			this._highlightFolderName = this._options.highlightFolderName || &#x27;highlight&#x27;;

			this.setPromise(this.getPromise().then(function () {
				this._prepareFolder();
			}.bind(this)).then(null, function (err) {
				console.log(err.stack);
			}));
		},


		/**
		 * Prepares the output folder
		 *
		 * @method _prepareFolder
		 * @private
		 */
		_prepareFolder: function () {
			if (!fs.existsSync(this._getApprovedPath())) {
				fs.mkdirSync(this._getApprovedPath());
			}
			if (!fs.existsSync(this._getBuildPath())) {
				fs.mkdirSync(this._getBuildPath());
			}
			if (!fs.existsSync(this._getHighlightPath())) {
				fs.mkdirSync(this._getHighlightPath());
			}
		},

		/**
		 * Reads an image and returns a promise
		 *
		 * @method _readImage
		 * @param {string} path
		 * @return {Promise} With {PNGImage} Image
		 * @private
		 */
		_readImage: function (path) {

			return new Promise(function (resolve, reject) {
				var image = PNGImage.readImage(path, function (err) {
					if (err) {
						reject(err);
					} else {
						resolve(image);
					}
				});
			});
		},

		/**
		 * Writes an image and returns a promise
		 *
		 * @method _writeImage
		 * @param {string} path
		 * @param {PNGImage} image
		 * @return {Promise}
		 * @private
		 */
		_writeImage: function (path, image) {

			return new Promise(function (resolve, reject) {
				image.writeImage(path, function (err) {
					if (err) {
						reject(err);
					} else {
						resolve();
					}
				});
			});
		},

		/**
		 * Reads a directory an returns all files found in the folder
		 *
		 * @method _readDir
		 * @param {string} path
		 * @returns {string[]}
		 * @private
		 */
		_readDir: function (path) {
			return fs.readdirSync(path);
		},

		/**
		 * Reads a directory and filters for png files, removing the extensions
		 *
		 * @method _readDirAndFilter
		 * @param {string} path
		 * @returns {string[]}
		 * @private
		 */
		_readDirAndFilter: function (path) {
			var files = this._readDir(path);
			return files.filter(this._pngFilter).map(function (filename) {
				return filename.substr(0, filename.length - 4);
			});
		},

		/**
		 * List filter for png extensions
		 *
		 * @method _pngFilter
		 * @param {string} filename
		 * @return {boolean}
		 * @private
		 */
		_pngFilter: function (filename) {
			return (filename.substr(-4).toLowerCase() === &#x27;.png&#x27;);
		},


		/**
		 * Gets the processing path
		 *
		 * @method _getPath
		 * @return {string}
		 * @private
		 */
		_getPath: function () {
			return this._path;
		},


		/**
		 * Gets the approved path
		 *
		 * @method _getApprovedPath
		 * @return {string}
		 * @private
		 */
		_getApprovedPath: function () {
			return path.join(this._getPath(), this._approvedFolderName);
		},

		/**
		 * Gets the build path
		 *
		 * @method _getBuildPath
		 * @return {string}
		 * @private
		 */
		_getBuildPath: function () {
			return path.join(this._getPath(), this._buildFolderName);
		},

		/**
		 * Gets the highlight path
		 *
		 * @method _getHighlightPath
		 * @return {string}
		 * @private
		 */
		_getHighlightPath: function () {
			return path.join(this._getPath(), this._highlightFolderName);
		},


		/**
		 * Gets a list of currently approve screen names
		 *
		 * @method getCurrentApprovedScreenNames
		 * @return {Promise} With {string[]} List of approved screen names
		 */
		getCurrentApprovedScreenNames: function () {
			return this.getPromise().then(function () {
				return this._readDirAndFilter(this._getApprovedPath());
			}.bind(this));
		},

		/**
		 * Gets a specific currently approved screen
		 *
		 * @method getCurrentApprovedScreen
		 * @param {string} name Name of approved screen
		 * @return {Promise} With {PNGImage} Approved screen
		 */
		getCurrentApprovedScreen: function (name) {
			return this.getPromise().then(function () {
				return this._readImage(path.join(this._getApprovedPath(), name + &#x27;.png&#x27;));
			}.bind(this));
		},

		/**
		 * Archives a specific currently approved screen
		 *
		 * @method archiveCurrentApprovedScreen
		 * @param {string} name Name of approved screen
		 * @param {PNGImage} image Screen to archive
		 * @return {Promise}
		 */
		archiveCurrentApprovedScreen: function (name, image) {
			// Do nothing
			return Promise.resolve();
		},


		/**
		 * Gets a list of approve screen names
		 *
		 * @method getApprovedScreenNames
		 * @return {Promise} With {string[]} List of approved screen names
		 */
		getApprovedScreenNames: function () {
			return this.getPromise().then(function () {
				return [];
			});
		},

		/**
		 * Gets a specific approved screen
		 *
		 * @method getApprovedScreen
		 * @param {string} name Name of approved screen
		 * @return {Promise} With {PNGImage} Approved screen
		 */
		getApprovedScreen: function (name) {
			return this.getPromise().then(function () {
				return undefined;
			});
		},

		/**
		 * Archives a specific approved screen
		 *
		 * @method archiveApprovedScreen
		 * @param {string} name Name of approved screen
		 * @param {PNGImage} image Screen to archive
		 * @return {Promise}
		 */
		archiveApprovedScreen: function (name, image) {
			// Do nothing
			return Promise.resolve();
		},


		/**
		 * Gets a list of build screen names
		 *
		 * @method getBuildScreenNames
		 * @return {string[]} List of build screen names
		 * @return {Promise} With {string[]} List of build screen names
		 */
		getBuildScreenNames: function () {
			return this.getPromise().then(function () {
				return this._readDirAndFilter(this._getBuildPath());
			}.bind(this));
		},

		/**
		 * Gets a specific build screen
		 *
		 * @method getBuildScreen
		 * @param {string} name Name of build screen
		 * @return {Promise} With {PNGImage}
		 */
		getBuildScreen: function (name) {
			return this.getPromise().then(function () {
				return this._readImage(path.join(this._getBuildPath(), name + &#x27;.png&#x27;));
			}.bind(this));
		},

		/**
		 * Archives a specific build screen
		 *
		 * @method archiveBuildScreen
		 * @param {string} name Name of build screen
		 * @param {PNGImage} image Screen to archive
		 * @return {Promise}
		 */
		archiveBuildScreen: function (name, image) {
			// Do nothing
			return Promise.resolve();
		},


		/**
		 * Gets a list of highlight screen names
		 *
		 * @method getHighlightScreenNames
		 * @return {string[]} List of highlight screen names
		 * @return {Promise} With {string[]} List of highlight screen names
		 */
		getHighlightScreenNames: function () {
			return this.getPromise().then(function () {
				return this._readDirAndFilter(this._getHighlightPath());
			}.bind(this));
		},

		/**
		 * Gets a specific highlight screen
		 *
		 * @method getHighlightScreen
		 * @param {string} name Name of highlight screen
		 * @return {Promise} With {PNGImage}
		 */
		getHighlightScreen: function (name) {
			return this.getPromise().then(function () {
				return this._readImage(path.join(this._getHighlightPath(), name + &#x27;.png&#x27;));
			}.bind(this));
		},

		/**
		 * Archives a specific highlight screen
		 *
		 * @method archiveHighlightScreen
		 * @param {string} name Name of highlight screen
		 * @param {PNGImage} image Screen to archive
		 * @return {Promise}
		 */
		archiveHighlightScreen: function (name, image) {
			return this.getPromise().then(function () {
				return this._writeImage(path.join(this._getHighlightPath(), name + &#x27;.png&#x27;), image);
			}.bind(this));
		}
	},

	{
		/**
		 * Type of class
		 *
		 * @property TYPE
		 * @type string
		 */
		TYPE: &#x27;FileStorageAdapter&#x27;
	});

module.exports = FileStorageAdapter;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
